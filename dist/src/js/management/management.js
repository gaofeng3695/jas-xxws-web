var organizationObj={$addDepart:$(".department_add span"),$frameAdd:$("#departmentAdd"),$frameModify:$("#departmentModify"),$addBtn:$("#addDepart"),$modifyBtn:$("#modifyDepart"),$selectedBtn:$("#selectedDepart"),$childList:$(".child_list"),_selectedId:null,_selectedName:null,_flag:!0,init:function(){var e=this;this.getAllData(),this.$addDepart.click(function(){""==e._selectedId||null==e._selectedId?xxwsWindowObj.xxwsAlert("请选择您要添加所在的部门！"):(e.$frameAdd.modal(),$("input[name=selectParentDepart]").attr("data-id",e._selectedId).val(e._selectedName))}),$("input[name=selectParentDepart]").click(function(){var e=$(this).attr("data-id");departmentObj.getAllData("addParent",e)}),this.$addBtn.click(function(){var t=$("input[name=addDepart]").val().trim(),a=$("input[name=selectParentDepart]").attr("data-id");1==e._flag&&(e._flag=!1,null==t||""==t?(xxwsWindowObj.xxwsAlert("请填写您要添加部门的名称！"),e.again()):t.length>20?(xxwsWindowObj.xxwsAlert("部门名称最长不超过20个字"),e.again()):e.addDepartment(t,a))}),$(".child_list").on("click",".delete_btn",function(){var t=$(this).closest("li").attr("data-id"),a={tip:"您是否确定删除此部门？",name_title:"提示",name_cancel:"取消",name_confirm:"确定",isCancelBtnShow:!0,callBack:function(){e.deleteDepartment(t)}};xxwsWindowObj.xxwsAlert(a)}),$(".child_list").on("click",".modify_btn",function(){var t=$(this).closest("li").attr("data-id"),a=$(this).closest("li").find("span.clildren_name").text();e.$frameModify.modal(),e.modifyData(t,a)}),$("input[name=parentDepart]").click(function(){var e=$(this).attr("data-id"),t=$("input[name=childDepart]").attr("data-id");departmentObj.getAllData("selectParent",e,t)}),this.$selectedBtn.click(function(){var e=departmentObj.getSelectDepart(),t=e.value;"addParent"==e.key?$("input[name=selectParentDepart]").attr("data-id",t[0].id).val(t[0].name):$("input[name=parentDepart]").attr("data-id",t[0].id).val(t[0].name)}),this.$modifyBtn.click(function(){var t=$("input[name=childDepart]").val().trim(),a=$("input[name=childDepart]").attr("data-id"),n=$("input[name=parentDepart]").attr("data-id");1==e._flag&&(e._flag=!1,null==t||""==t?(xxwsWindowObj.xxwsAlert("请填写您要修改部门的名称！"),e.again()):t.length>20?(xxwsWindowObj.xxwsAlert("部门名称最长不超过20个字"),e.again()):e.updateDepart(a,t,n))})},getAllData:function(){var e=this,t=lsObj.getLocalStorage("userBo");$.ajax({type:"GET",url:"/cloudlink-core-framework/organization/getTree?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:{token:lsObj.getLocalStorage("token"),enterpriseId:JSON.parse(t).enterpriseId},dataType:"json",success:function(t){e.renderDepartment(t.rows)}})},renderDepartment:function(e){var t=this,a={view:{showLine:!1,showIcon:!1,addDiyDom:function(e,t){var a=$("#"+t.tId+"_switch"),n=$("#"+t.tId+"_ico");if(a.remove(),n.before(a),t.level>1){var i="<span style='display: none;width:"+0*(t.level-1)+"px'></span>";a.before(i)}}},data:{key:{name:"name"},simpleData:{enable:!0,pIdKey:"pid"}},check:{enable:!1,chkStyle:"checkbox"},callback:{beforeClick:function(e,a){t.zTree.expandNode(a,!0),t.showChildList(a.id,a.name)}}};if(t.zTree=$.fn.zTree.init($("#department_list"),a,e),t.zTree.expandAll(!0),""==t._selectedId||null==t._selectedId){var n=t.zTree.getNodes();t.zTree.selectNode(n[0]),t.showChildList(n[0].id,n[0].name)}else{var n=t.zTree.getNodesByParam("id",t._selectedId,null);t.zTree.selectNode(n[0]),t.showChildList(n[0].id,n[0].name)}},showChildList:function(e,t){var a=this;$.ajax({type:"GET",url:"/cloudlink-core-framework/user/getChildrenOrgUserCount?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:{orgId:e},dataType:"json",success:function(n){if(1==n.success){a.$childList.html(""),a._selectedId=e,a._selectedName=t;var i=null,l=null,d=n.rows;if(d.length>0)for(var o=0;o<d.length;o++)l=d[o].activeUserCount+d[o].unactiveUserCount+d[o].frozenUserCount,i='<li data-id="'+d[o].orgId+'"><span class="clildren_name">'+d[o].orgName+'</span><span data-placement="top" title="已激活'+d[o].activeUserCount+"人，未激活"+d[o].unactiveUserCount+"人，冻结"+d[o].frozenUserCount+'人" data-toggle="tooltip" class="children_num"><b>'+l+'</b>&nbsp;人</span><i class="delete_btn" title="删除"></i><i class="modify_btn" title="修改"></i></li>',a.$childList.append(i);else i="<li>暂无子部门</li>",a.$childList.append(i);$('[data-toggle="tooltip"]').tooltip()}else xxwsWindowObj.xxwsAlert("获取数据失败！")},error:function(){xxwsWindowObj.xxwsAlert("获取数据失败！")}})},getChildList:function(e){this.$childList.html(""),this._selectedId=e.id,this._selectedName=e.name;var t=null;if(e.children.length>0)for(var a=0;a<e.children.length;a++)t='<li data-id="'+e.children[a].id+'"><span class="clildren_name">'+e.children[a].name+'</span><span data-placement="top" title="已激活12人，未激活10人，冻结8人" data-toggle="tooltip" class="children_num"><b>122</b>&nbsp;人</span><i class="delete_btn" title="删除"></i><i class="modify_btn" title="修改"></i></li>',this.$childList.append(t);else t="<li>暂无子部门</li>",this.$childList.append(t);$('[data-toggle="tooltip"]').tooltip()},addDepartment:function(e,t){var a=this,n=JSON.parse(lsObj.getLocalStorage("userBo")).enterpriseId,i={orgName:e,enterpriseId:n,parentId:t,manager:""};$.ajax({type:"POST",url:"/cloudlink-core-framework/organization/add?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify(i),dataType:"json",success:function(e){1==e.success?($("input[name=addDepart]").val(""),a._selectedId=t,a.$frameAdd.modal("hide"),a.getAllData()):400==e.code&&"已存在同名组织机构"==e.msg?xxwsWindowObj.xxwsAlert("创建失败，已存在同名组织机构！"):xxwsWindowObj.xxwsAlert("创建部门失败！"),a.again()},error:function(){xxwsWindowObj.xxwsAlert("创建部门失败！"),a.again()}})},deleteDepartment:function(e){var t=this;$.ajax({type:"POST",url:"/cloudlink-core-framework/organization/deleteMultiple?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify({objectId:e}),dataType:"json",success:function(e){if(1==e.success)xxwsWindowObj.xxwsAlert("删除成功！"),t.getAllData();else if(400==e.code)xxwsWindowObj.xxwsAlert("删除异常");else if(501==e.code){var a={tip:"您所删除的组织机构已经不存在",name_title:"提示",name_cancel:"取消",name_confirm:"确定",isCancelBtnShow:!1,callBack:function(){t.getAllData()}};xxwsWindowObj.xxwsAlert(a)}else 502==e.code&&xxwsWindowObj.xxwsAlert("您所删除的组织机构扔存在人员，无法删除!")},error:function(){xxwsWindowObj.xxwsAlert("删除组织机构失败！")}})},updataDepartment:function(e,t,a){var n=this,i={objectId:e,orgName:t,parentId:a};$.ajax({type:"POST",url:"/cloudlink-core-framework/organization/update?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify(i),dataType:"json",success:function(e){1==e.success?(n.$frameModify.modal("hide"),n.getAllData()):(xxwsWindowObj.xxwsAlert(e.msg),n.again())},error:function(){xxwsWindowObj.xxwsAlert("当前网络不稳定,请稍后再试"),n.again()}})},updataParentDepart:function(e,t,a){var n=this,i={targetId:a,sourceId:e,type:"append"};$.ajax({type:"POST",url:"/cloudlink-core-framework/organization/updateOrganizationTree?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify(i),dataType:"json",success:function(i){1==i.success?(n.updataDepartment(e,t,a),n._selectedId=a):xxwsWindowObj.xxwsAlert(i.msg),n.again()},error:function(){xxwsWindowObj.xxwsAlert("当前网络不稳定,请稍后再试"),n.again()}})},updateDepart:function(e,t,a){var n=this,i={objectId:e,orgName:t,parentId:a};$.ajax({type:"POST",url:"/cloudlink-core-framework/organization/update?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify(i),dataType:"json",success:function(e){1==e.success?(n._selectedId=a,n.$frameModify.modal("hide"),n.getAllData()):400==e.code&&"已存在同名组织机构"==e.msg?xxwsWindowObj.xxwsAlert("修改失败，已存在同名组织机构！"):xxwsWindowObj.xxwsAlert("修改组织机构失败！"),n.again()},error:function(){xxwsWindowObj.xxwsAlert("修改组织机构失败！"),n.again()}})},modifyData:function(e,t){var a=this;this.$frameModify.on("shown.bs.modal",function(n){$("input[name=childDepart]").attr("data-id",e).val(t),$("input[name=parentDepart]").attr("data-id",a._selectedId).val(a._selectedName)})},again:function(){this._flag=!0}};$(function(){organizationObj.init(),$(document).on("show.bs.modal",".modal",function(e){var t=1040+10*$(".modal:visible").length;$(this).css("z-index",t),setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",t-1).addClass("modal-stack")},0)}),$(document).on("hidden.bs.modal",".modal",function(e){$(".modal:visible").length>0&&$("body").addClass("modal-open")})});