var repairObj={$repairDetails:$("#repairDetails"),$repairHistory:$("#repairHistory"),_repairId:null,_historySeachKey:"",_historySeachId:"",_isModify:null,detailsInitial:{address:"---",buzId:"---",captialTotalCost:"---",contactPhone:"---",content:"---",createTime:"---",createUserId:"---",createUserName:"---",enterpriseId:"---",maintenanceCode:"---",maintenanceName:"---",maintenanceRecordTime:"---",objectId:"---",orgId:"---",originTypeCode:"---",originTypeName:"---",pic:[],reason:"---",relationshipPersonIds:"",relationshipPersonNames:"---",relationshipPersons:[],remediationTime:"---",satisfaction:"---",signature:[],status:"---",totalCost:"---",typeCode:"---",typeName:"---",workRecordCost:[],workRecordId:""},axisInitial:[{operateTypeCode:"---",operateTypeName:"---",operateContent:"---",createUserId:"---",createUserName:"---",createTime:"---",opDate:"---",opTime:"---"}],init:function(){var e=this;e.$repairDetails.on("shown.bs.modal",function(i){detailsV.getRepairDetails(e._repairId),detailsV.getRepairAxis(e._repairId)}),$(".historySeachBtn").click(function(){e._historySeachKey=$(".historySeachMain input").val().trim(),e.getHistoryTable()}),e.$repairHistory&&e.historyTable()},openDetailsFrame:function(e,i,t){detailsV.which_to_show="MO_01"==i?"user":"MO_02"==i?"facility":"MO_03"==i?"event":"other",this._repairId=e,this._isModify=t,detailsV.maintenanceCode="---",$.extend(detailsV.dataBasics,this.detailsInitial,!0),Vue.set(detailsV.dataAxis,"operateList",this.axisInitial),detailsV.witchName(t),detailsV.tabChange("details"),this.$repairDetails.modal()},openHistoryFrame:function(e){this.$repairHistory.modal(),this._historySeachKey="",this._historySeachId=e,$(".historySeachMain input").val(""),this.getHistoryTable()},historyTable:function(){var e=this,i={keyword:"",buzId:"",pageNum:1,pageSize:10};$("#repairTableHistory").bootstrapTable({url:"/cloudlink-inspection-event/commonData/maintenanceWorkHistory/getPageList?token="+lsObj.getLocalStorage("token"),method:"post",cache:!1,showHeader:!0,pagination:!0,striped:!0,sidePagination:"server",pageNumber:1,pageSize:10,pageList:[10,20,50],search:!1,searchOnEnterKey:!1,queryParamsType:"",queryParams:function(e){return i.pageSize=e.pageNumber,i.pageNum=e.pageSize,i},onLoadSuccess:function(e){e.success},onDblClickRow:function(i){return e.openDetailsFrame(i.objectId,i.originTypeCode),!1},columns:[{field:"maintenanceCode",title:"维修编号",align:"center",visible:!0,sortable:!1,width:"17%",editable:!0},{field:"maintenanceRecordTime",title:"维修时间",align:"center",visible:!0,sortable:!1,width:"17%",editable:!0},{field:"originTypeName",title:"维修来源",align:"center",visible:!0,sortable:!1,width:"10%",editable:!0},{field:"relationshipPersonNames",title:"维修人",align:"center",visible:!0,sortable:!1,width:"20%",editable:!0},{field:"reason",title:"维修原因",align:"center",visible:!0,sortable:!1,width:"31%",editable:!0},{field:"operate",title:"操作",align:"center",events:e.historyTableEvent(),width:"5%",formatter:e.historyTableOperation}]})},getHistoryTable:function(){var e=this,i={keyword:e._historySeachKey,buzId:e._historySeachId,pageNum:1,pageSize:10};$("#repairTableHistory").bootstrapTable("refreshOptions",{queryParams:function(e){return i.pageNum=e.pageNumber,i.pageSize=e.pageSize,i}})},historyTableOperation:function(e,i,t){return['<a class="look" href="javascript:void(0)" title="查看">',"<i></i>","</a>"].join("")},historyTableEvent:function(){var e=this;return{"click .look":function(i,t,a,s){return e.openDetailsFrame(a.objectId,a.originTypeCode),!1}}}};$(function(){repairObj.init()});var User=Vue.extend({props:["myMsgdetails"],template:'<div class="frameList"><div class="frameListHalf"><div class="frameListLeft">用户姓名</div><div class="frameListRight"><p>{{maintenanceName}}</p></div></div><div class="frameListHalf"><div class="frameListLeft">联系方式</div><div class="frameListRight"><p>{{contactPhone}}</p></div></div></div><div class="frameList"><div class="frameListLeft">用户地址</div><div class="frameListRight"><p>{{address}}</p></div></div>',data:function(){return this.myMsgdetails}}),Facility=Vue.extend({props:["myMsgdetails"],template:'<div class="frameList"><div class="frameListHalf"><div class="frameListLeft">设施名称</div><div class="frameListRight"><p>{{maintenanceName}}</p></div></div><div class="frameListHalf"><div class="frameListLeft">设施类型</div><div class="frameListRight"><p>{{typeName}}</p></div></div></div><div class="frameList"><div class="frameListLeft">设施位置</div><div class="frameListRight"><p>{{address}}</p></div></div>',data:function(){return this.myMsgdetails}}),Events=Vue.extend({props:["myMsgdetails"],template:'<div class="frameList"><div class="frameListHalf"><div class="frameListLeft">事件编号</div><div class="frameListRight"><p>{{maintenanceName}}</p></div></div><div class="frameListHalf"><div class="frameListLeft">事件类型</div><div class="frameListRight"><p>{{typeName}}</p></div></div></div><div class="frameList"><div class="frameListLeft">事件地点</div><div class="frameListRight"><p>{{address}}</p></div></div>',data:function(){return this.myMsgdetails}}),Other=Vue.extend({props:["myMsgdetails"],template:'<div class="frameList"><div class="frameListHalf"><div class="frameListLeft">联系人</div><div class="frameListRight"><p>{{maintenanceName}}</p></div></div><div class="frameListHalf"><div class="frameListLeft">联系方式</div><div class="frameListRight"><p>{{contactPhone}}</p></div></div></div><div class="frameList"><div class="frameListLeft">地址</div><div class="frameListRight"><p>{{address}}</p></div></div>',data:function(){return this.myMsgdetails}}),childComponent=Vue.extend({props:["myOrderdeta"],template:'<div class="frameDetailsTitle">维修费用</div><child-list v-for="team in workRecordCostArr(workRecordCost)" v-bind:names="team.name" v-bind:prices="team.price" v-bind:amounts="team.amount"></child-list><div class="frameList"><div class="frameListLeft">总计</div><div class="frameListRight"><p>{{totalCost | pliceNumber}}  （{{captialTotalCost}}）人民币</p></div></div><div class="frameList"><div class="frameListLeft">维修内容</div><div class="frameListRight"><p>{{content}}</p></div></div><div class="frameList"><div class="frameListLeft">照片</div><div class="frameListRight"><ul><span v-if="picShow">无</span><li class="event_pic_list" v-for="(picTeam,index) in pic"><img :src="imgSrc(index)" data-original="/cloudlink-core-file/file/downLoad?fileId={{index}}" @click="previewPicture($event)" alt=""/></li></ul></div></div><div class="frameList" v-if="operationShow"><div class="frameListLeft">用户签字</div><div class="frameListRight"><ul><li class="event_pic_list" v-for="(picTeam,index) in signature"><img :src="imgSrc(index)" data-original="/cloudlink-core-file/file/downLoad?fileId={{index}}" @click="previewPicture($event)" alt=""/></li></ul></div></div><div class="frameList" v-if="operationShow"><div class="frameListLeft">用户满意度</div><div class="frameListRight satisfaction" v-html="starHtml"></div></div>',data:function(){return this.myOrderdeta},computed:{starHtml:function(){switch(this.satisfaction){case"1":var e='<ul><li><img src="/src/images/security/star.png" width="20" alt=""></li></ul><span>非常不满</span>';return e;case"2":var e='<ul><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li></ul><span>不满意</span>';return e;case"3":var e='<ul><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li></ul><span>一般</span>';return e;case"4":var e='<ul><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li></ul><span>满意</span>';return e;case"5":var e='<ul><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li><li><img src="/src/images/security/star.png" width="20" alt=""></li></ul><span>非常满意</span>';return e;default:var e="<p> </p>";return e}},picShow:function(){return!(this.pic.length>0)},operationShow:function(){return"MO_01"==this.originTypeCode}},filters:{pliceNumber:function(e,i,t){i=i||",",t=t||".";var a=e<0?"-":"",s=parseInt(e=Math.abs(+e||0).toFixed(2),10)+"",r=(r=s.length)>3?r%3:0;return a+(r?s.substr(0,r)+i:"")+s.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(t+Math.abs(e-s).toFixed(2).slice(2))}},methods:{workRecordCostArr:function(e){if(e.length>0)return e;var i={name:"",prices:"",amount:""};return e.push(i)},imgSrc:function(e){return"/cloudlink-core-file/file/getImageBySize?fileId="+e+"&viewModel=fill&width=104&hight=78"},previewPicture:function(e){viewPicObj.viewPic(e.currentTarget)}}}),childList=Vue.extend({props:["names","prices","amounts"],template:'<div class="frameList"><div class="frameListThird"><div class="frameListLeft">名称</div><div class="frameListRight"><p>{{names}}</p></div></div><div class="frameListThird"><div class="frameListLeft">单价</div><div class="frameListRight"><p>{{prices|pliceNumber}}</p></div></div><div class="frameListThird"><div class="frameListLeft">数量</div><div class="frameListRight"><p>{{amounts}}</p></div></div></div>',filters:{pliceNumber:function(e,i,t){if(""==e||null==e||void 0==e)return"";i=i||",",t=t||".";var a=e<0?"-":"",s=parseInt(e=Math.abs(+e||0).toFixed(2),10)+"",r=(r=s.length)>3?r%3:0;return a+(r?s.substr(0,r)+i:"")+s.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(t+Math.abs(e-s).toFixed(2).slice(2))}}});Vue.component("child-component",childComponent),Vue.component("child-list",childList);var Axis={props:["myMsgaxis"],template:'<div class="axisDay" v-for="teamarr in dateArr" v-bind:dateName="teamarr.id">                    <div class="axisDayTitle">{{dateChange(teamarr.id)}}</div>                    <div class="axisTime">                        <div class="axisTimeList" v-for="team in timeArr(teamarr.id)">                            <span>{{team.opTime}}</span>                            <p>{{team.createUserName}}<i>{{team.operateTypeName}}</i>{{team.operateContent}}</p>                        </div>                    </div>                </div>',data:function(){return this.myMsgaxis},computed:{dateArr:function(){for(var e=this.operateList,i=[],t="",a=0;a<e.length;a++)if(t!=e[a].opDate){t=e[a].opDate;var s={id:t};i.push(s)}return i}},methods:{timeArr:function(e){for(var i=this.operateList,t=[],a=0;a<i.length;a++)i[a].opDate==e&&t.push(i[a]);return t},dateChange:function(e){return e==(new Date).Format("yyyy-MM-dd")?"今天（"+e+"）":e==this.GetDateStr(-1)?"昨天（"+e+"）":e},GetDateStr:function(e){var i=new Date;i.setDate(i.getDate()+e);var t=i.getFullYear(),a=i.getMonth()+1,s=i.getDate();return a<10&&(a="0"+a),s<10&&(s="0"+s),t+"-"+a+"-"+s}}};Vue.component("axis-html",Axis);var detailsV=new Vue({el:"#repairDetails",data:{which_to_show:"user",maintenanceCode:"---",detailsShow:!0,axisShow:!1,modifyShow:!1,frameName:"",dataAxis:{maintenanceCode:"---",reason:"---",operateList:[{operateTypeCode:"---",operateTypeName:"---",operateContent:"---",createUserId:"---",createUserName:"---",createTime:"---",opDate:"---",opTime:"---"}]},dataBasics:{address:"---",buzId:"---",captialTotalCost:"---",contactPhone:"---",content:"---",createTime:"---",createUserId:"---",createUserName:"---",enterpriseId:"---",maintenanceCode:"---",maintenanceName:"---",maintenanceRecordTime:"---",objectId:"---",orgId:"---",originTypeCode:"---",originTypeName:"---",pic:[],reason:"---",relationshipPersonIds:"",relationshipPersonNames:"---",relationshipPersons:[],remediationTime:"---",satisfaction:"---",signature:[],status:"---",totalCost:"---",typeCode:"---",typeName:"---",workRecordCost:[],workRecordId:""}},components:{user:User,facility:Facility,event:Events,other:Other},computed:{statusName:function(){return 1==this.dataBasics.status?"待维修":2==this.dataBasics.status?"已完成":"---"},orderShow:function(){return""!=this.dataBasics.workRecordId&&null!=this.dataBasics.workRecordId&&void 0!=this.dataBasics.workRecordId}},methods:{tabChange:function(e){"details"==e?(this.detailsShow=!0,this.axisShow=!1):(this.detailsShow=!1,this.axisShow=!0)},witchName:function(e){e?(this.frameName="维修记录编辑",this.modifyShow=!0):(this.frameName="维修详情",this.modifyShow=!1)},getRepairDetails:function(e){var i=this,t={objectId:e};repairObj._selectedPersons=[],$.ajax({type:"GET",url:"/cloudlink-inspection-event/commonData/maintenanceWork/get?token="+lsObj.getLocalStorage("token"),data:t,contentType:"application/json",dataType:"json",success:function(e,t){1==e.success?(i.maintenanceCode=e.rows[0].maintenanceCode,$.extend(detailsV.dataBasics,e.rows[0],!0),i.ergodicPersons(e.rows[0].relationshipPersons)):xxwsWindowObj.xxwsAlert("获取数据失败！")}})},getRepairAxis:function(e){var i={objectId:e};$.ajax({type:"POST",url:"/cloudlink-inspection-event/commonData/maintenanceOperate/getList?token="+lsObj.getLocalStorage("token"),data:JSON.stringify(i),contentType:"application/json",dataType:"json",success:function(e,i){1==e.success?Vue.set(detailsV.dataAxis,"operateList",e.rows[0].operateList):xxwsWindowObj.xxwsAlert("获取数据失败！")}})},ergodicPersons:function(e){for(var i=0;i<e.length;i++){var t={relationshipPersonId:e[i].relationshipPersonId,relationshipPersonName:e[i].relationshipPersonName};repairObj._selectedPersons.push(t)}},openPerson:function(){userTable._selectPeople=repairObj._selectedPersons,createmaintenance.chooserepairer(!0)},getSelectPerson:function(e,i){repairObj._selectedPersons=[];for(var t=0;t<e.length;t++)repairObj._selectedPersons.push(e[t]);this.dataBasics.relationshipPersonNames=i},modifySave:function(){var e=this;if(0==repairObj._selectedPersons.length)xxwsWindowObj.xxwsAlert("请选择维修人员");else{var i={objectId:e.dataBasics.objectId,relationshipPerson:repairObj._selectedPersons};$.ajax({type:"POST",url:"/cloudlink-inspection-event/maintenanceWork/updateMaintenancePersonnel?token="+lsObj.getLocalStorage("token"),data:JSON.stringify(i),contentType:"application/json",dataType:"json",success:function(e,i){if(1==e.success){var t={tip:"新建维修成功",name_title:"提示",name_cancel:"取消",name_confirm:"确定",isCancelBtnShow:!1,callBack:function(){repairObj.$repairDetails.modal("hide"),window.location.reload()}};xxwsWindowObj.xxwsAlert(t)}else"XE05001"==e.code?xxwsWindowObj.xxwsAlert("维修工单已结束，维修人员不能修改"):xxwsWindowObj.xxwsAlert("维修人员修改失败！")}})}}}});