function closeImg(e){var t=$(e).attr("data-key");$(e).closest(".feedback_images").remove(),$(".feedback_img_file input[name=file]").each(function(){console.log($(this).attr("data-value")),$(this).attr("data-value")==t&&$(this).remove()})}function initTable(){$("#table").bootstrapTable({url:"/cloudlink-inspection-event/eventInfo/web/v1/getPageList?token="+lsObj.getLocalStorage("token"),method:"post",toolbar:"#toolbar",toolbarAlign:"left",cache:!1,showHeader:!0,showRefresh:!0,pagination:!0,striped:!0,sidePagination:"server",pageNumber:1,pageSize:10,pageList:[10,20,50],search:!1,searchOnEnterKey:!1,queryParamsType:"",queryParams:function(e){return searchObj.queryObj.pageSize=e.pageSize,searchObj.queryObj.pageNum=e.pageNumber,searchObj.queryObj},responseHandler:function(e){return e},onLoadSuccess:function(e){1==e.success&&(e.rows.length>0?mapObj.setPointsMarkerWithCenterPointAndZoomLevel(e.rows):mapObj.$bdMap.clearOverlays())},columns:[{field:"state",checkbox:!0,align:"center",visible:!0,sortable:!1,width:"3%"},{field:"occurrenceTime",title:"事件发生时间",align:"center",visible:!0,sortable:!1,width:"15%",editable:!0},{field:"fullTypeName",title:"事件类型",align:"center",visible:!0,sortable:!1,width:"17%",editable:!0,cellStyle:function(e,t,a){return{css:{"max-width":"300px"}}}},{field:"statusValue",title:"事件状态",align:"center",visible:!0,sortable:!1,width:"10%",editable:!0},{field:"address",title:"事件地点",align:"center",visible:!0,sortable:!1,width:"27%"},{field:"inspectorName",title:"上报人",align:"center",visible:!0,sortable:!1,width:"15%",editable:!0},{field:"eventIconName",title:"eventIconName",align:"center",visible:!1,sortable:!1,width:"15%",editable:!0},{field:"operate",title:"操作",align:"center",events:operateEvents,width:"13%",formatter:operateFormatter}]})}function operateFormatter(e,t,a){return['<a class="location" href="javascript:void(0)" title="定位">',"<i></i>","</a>",'<a class="check" data-toggle="modal" href="javascript:void(0)" title="查看">',"<i></i>","</a>"].join("")}function checkLen(e){var t=$(e).val().length;t>159&&$(e).val($(e).val().substring(0,160));var a=160-t;a<0&&(a=0),$(".text_num").text("("+a+"字)")}$(function(){searchObj.init(),mapObj.init(),mapAddObj.init(),addListenEventHandle(),initTable(),exportFileObj.init(),drafting("event_map","drafting_down"),pipeLineObj.init(mapObj.$bdMap),pipelinebtnObj.init($(".event_map"))}),function(e,t,a){var n={queryObj:{keyword:"",status:"20,21,30",type:"",date:"all",startDate:"",endDate:"",pageNum:1,pageSize:10,iscustorm:"1"},init:function(){this.requestEventType()},requestEventType:function(){var e=this,n={};t.ajax({type:"POST",url:"/cloudlink-inspection-event/commonData/eventType/getList?token="+lsObj.getLocalStorage("token"),data:JSON.stringify(n),contentType:"application/json",dataType:"json",success:function(t){if(1==t.success){e.foramtEventType(t.rows);var n=e.createSearchTemplateObj(e.aActiveData,e.hisData);e.searchInst=a(n),e.hisData.length>0&&(e.bindEvent(),e.renderEventTypeTree(e.hisData)),eventObj.init()}else xxwsWindowObj.xxwsAlert("网络异常请稍候尝试！")}})},foramtEventType:function(e){var t={};e.forEach(function(e){0==+e.parentId&&(t[e.objectId]={typeName:e.typeName,nodeType:e.nodeType,indexNum:e.indexNum,active:e.active,aHisData:[],aActiveData:[]})}),e.forEach(function(e){0!=+e.parentId&&(0==+e.active?t[e.parentId].aHisData.push({isParent:!1,treenodename:e.typeName,pid:e.parentId,id:e.objectId}):t[e.parentId].aActiveData.push({name:e.typeName,value:e.objectId}))}),this._formatTypeDataForActiveAndHis(t)},_formatTypeDataForActiveAndHis:function(e){var t=this,a=[],n=[];for(var i in e)if(e.hasOwnProperty(i)){var o=e[i];if(o.aHisData.length>0&&1!=+o.nodeType&&([].push.apply(a,o.aHisData),a.push({isParent:!0,treenodename:o.typeName,pid:"",id:i})),1==+o.nodeType&&0==+o.active&&a.push({isParent:!1,treenodename:o.typeName,pid:"",id:i}),o.aActiveData.length>0){var s=o.aActiveData.map(function(e){return e.value}).join(","),r=o.aActiveData.length>1?[{name:"全部",value:s}].concat(o.aActiveData):o.aActiveData;n[o.indexNum]={name:o.typeName,value:i,subValue:s,children:r}}1==+o.nodeType&&1==+o.active&&(n[o.indexNum]={name:o.typeName,value:i})}t.hisData=a,t.aActiveData=n.filter(function(e){return e})},_initSearcEventType:function(e,t){var a=[{name:"全部",value:""}].concat(e);return a.push(t.length>0&&['<span class="fl history">','<span class="fl itemHisData">历史类型：</span>','<span class="peo_wrapper" data-class="userIds">','<span class="peo_border">','<input id="hisTypeInput" class="peo_selected" readonly>','<span class="mybtn"></span>',"</span>",'<span id="clear_type" class="clear">清空</span>',"</span>","</span>"].join("")),a},createSearchTemplateObj:function(e,a){var n=this;return{wrapper:"#search_wrapper",topItem:{widthRate:[6,6],data:[{title:{name:"完成状态",value:"status"},items:[{name:"全部",value:"20,21,30"},{name:"处理中",value:"20"},{name:"已完成",value:"21,30"}]},"date"]},itemArr:[{title:{name:"事件类型",value:"type"},items:n._initSearcEventType(e,a)},"date"],cbRender:function(){t(".itemHisData").removeClass("active")},queryObj:this.queryObj,callback:function(e){n.refreshTable()}}},refreshTable:function(){var e=this;e.queryObj.pageNum="1",t("#table").bootstrapTable("refreshOptions",{pageNumber:+e.queryObj.pageNum,pageSize:+e.queryObj.pageSize,queryParams:function(t){return e.queryObj.pageSize=t.pageSize,e.queryObj.pageNum=t.pageNumber,e.queryObj}})},bindEvent:function(){var e=this;t("body").on("click",".peo_border",function(){t("#hisData").modal()}),t("body").on("click","#btn_hisData",function(){if(e._setSelectedItems(),t(".item2_id").hide(),t("#hisTypeInput").val(e.aTypeName.join("，")),t("#hisData").modal("hide"),!e.aTypeId||0===e.aTypeId.length)return void t("#clear_type").trigger("click");t(".itemHisData").addClass("active"),t('div[data-class="type"]').find(".item").removeClass("active"),e.queryObj.type=e.aTypeId.join(","),e.searchInst.callback()}),t("body").on("click","#clear_type",function(){e._clearHisActive(),e.queryObj.type="",e.searchInst.renderActive({type:""}),e.searchInst.callback()}),t("body").on("click",".search_reset",function(){e._clearHisActive()})},renderEventTypeTree:function(e){var a=this,n={view:{showLine:!0,showIcon:!1},data:{key:{name:"treenodename"},simpleData:{enable:!0,pIdKey:"pid"}},check:{enable:!0,chkStyle:"checkbox"}};a.zTree=t.fn.zTree.init(t("#eventType_list"),n,e),a.zTree.expandAll(!0)},_setSelectedItems:function(){var e=this;e.aTypeId=[],e.aTypeName=[],e.zTree.getCheckedNodes(!0).forEach(function(t,a){t.isParent||(e.aTypeId.push(t.id),e.aTypeName.push(t.treenodename))})},_clearHisActive:function(){var e=this;e.aTypeId=null,e.aTypeName=null,t("#hisTypeInput").val(""),t(".itemHisData").removeClass("active"),e.zTree.checkAllNodes(!1)}};e.searchObj=n}(window,$,createSearhTemplate);var eventObj={$addBtn:$("#btn_add"),$submit:$(".submit"),$mapA:$(".map_address"),$lon:$("input[name=lon]"),$lat:$("input[name=lat]"),$eventM:$("#addEvent"),$mapM:$("#event_address"),$receiveUser:$("input[name=receiveUser]"),receiveUserIdsArr:[],_eventObjectId:null,$eventId:null,$flg:!0,init:function(){var e=this;this.$addBtn.click(function(){e.eventOpen()}),this.$mapA.click(function(){e.mapOpen()}),this.$submit.click(function(){e.submit()}),this.$receiveUser.click(function(){$("#stakeholder").modal(),e.requestPeopleTree()}),$("#btn_selectPeople").click(function(){e.setSelectedPerson()}),this.$mapM.on("shown.bs.modal",function(){mapAddObj.reload()}),$("#details").on("shown.bs.modal",function(t){detailsObj.loadEventDetails(e._eventObjectId)}),this.getType()},eventOpen:function(){var e=(new Date).Format("yyyy-MM-dd HH:mm");$("#datetime").val(e),this.$eventM.modal()},mapOpen:function(){this.$mapM.modal(),this.iconHide()},submit:function(){var e=this;this.$eventId=baseOperation.createuuid();var t=$("#datetime").val(),a=this.$mapA.val(),n=$("#event_description").val().trim();if(1==this.$flg){if(this.$flg=!1,""==$("#eventType").val()||null==$("#eventType").val()||void 0==$("#eventType").val())return xxwsWindowObj.xxwsAlert("请选择发生事件的类型！"),this.again(),!1;if(""==t)return xxwsWindowObj.xxwsAlert("请选择发生事件的时间！"),this.again(),!1;if(""==a)return xxwsWindowObj.xxwsAlert("请选择发生事件的地点！"),this.again(),!1;if(""==n)return xxwsWindowObj.xxwsAlert("请描述发生的事件！"),this.again(),!1;var i={tip:"您是否确定上报事件？",name_title:"提示",name_cancel:"取消",name_confirm:"确定",isCancelBtnShow:!0,callBack:function(){e.uploadFile()}};xxwsWindowObj.xxwsAlert(i),this.again()}},uploadFile:function(){var e=0,t=this,a=$(".feedback_img_file").find("input[name=file]");if(a.length>0)for(i=0;i<a.length;i++){var n=a.eq(i).attr("id");$.ajaxFileUpload({url:"/cloudlink-core-file/attachment/web/v1/save?businessId="+t.$eventId+"&bizType=pic&token="+lsObj.getLocalStorage("token"),secureuri:!1,fileElementId:n,dataType:"json",type:"POST",async:!1,success:function(n,i){1==n.success?++e==a.length&&t.uploadData():(xxwsWindowObj.xxwsAlert("当前网络不稳定"),t.again())}})}else t.uploadData()},uploadData:function(){var e=this,t=this.formData();$.ajax({type:"POST",url:"/cloudlink-inspection-event/eventInfo/saveBatch?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify(t),dataType:"json",success:function(t,a){1==t.success?($("input[type='text']").val(""),e.$eventM.modal("hide"),window.location.reload()):(xxwsWindowObj.xxwsAlert("保存事件失败！"),e.again())}})},formData:function(){var e=this,t=$("#datetime").val(),a=(e.$mapA.val(),$("#event_description").val().trim()),n=$("input[name=state]:checked").val(),i=(new Date).Format("yyyyMMddHHmmssS"),o=(new Date).Format("yyyy-MM-dd"),s={userId:mapObj.$user.objectId,userName:mapObj.$user.userName};e.receiveUserIdsArr.push(s);var r=[],l={objectId:this.$eventId,type:$("#eventType").val(),occurrenceTime:t,address:e.$mapA.val(),description:a,eventCode:i,reportTime:o,status:n,bdLon:e.$lon.val(),bdLat:e.$lat.val(),lon:"0",lat:"0",taskUserMsg:e.receiveUserIdsArr};return r.push(l),r},getType:function(){var e=searchObj.aActiveData,t=e.map(function(e,t){return e.children?e.children.map(function(t){return"全部"===t.name?"":"<option value="+t.value+">"+e.name+"&nbsp-&nbsp"+t.name+"</option>"}).join(""):"<option value="+e.value+">"+e.name+"</option>"}).join("");$("#eventType").append(t)},requestPeopleTree:function(){var e=this;e.aAllPeople||$.ajax({type:"GET",url:"/cloudlink-core-framework/user/getOrgUserTree",contentType:"application/json",data:{token:lsObj.getLocalStorage("token"),status:1},dataType:"json",success:function(t){var a=t.rows;if(1!=t.success)return void xxwsWindowObj.xxwsAlert("获取人员信息失败！");for(var n=0;n<a.length;n++)a[n].id==mapObj.$user.objectId&&a.splice(n,1);e.aAllPeople=a,e.renderPeopleTree(e.aAllPeople)},statusCode:{404:function(){xxwsWindowObj.xxwsAlert("获取人员信息失败！")}}})},renderPeopleTree:function(e){var t=this,a={view:{showLine:!0},data:{key:{name:"treenodename"},simpleData:{enable:!0,pIdKey:"pid"}},check:{enable:!0,chkStyle:"checkbox"}};t.zTree=$.fn.zTree.init($("#people_list"),a,e),t.zTree.expandAll(!0)},setSelectedPerson:function(){var e=this;e.aPeopleName=[],e.receiveUserIdsArr=[];var t=null;e.zTree.getCheckedNodes(!0).forEach(function(a,n){a.isParent||(t={userId:a.id,userName:a.treenodename},e.receiveUserIdsArr.push(t),e.aPeopleName.push(a.treenodename))}),e.$receiveUser.val(e.aPeopleName.join("，")),$("#stakeholder").modal("hide")},initPeopleList:function(){var e=this;e.aPeopleName=[],e.receiveUserIdsArr=[],e.$receiveUser.val(""),e.zTree&&e.zTree.checkAllNodes(!1)},iconHide:function(){$(".BMap_cpyCtrl.BMap_noprint.anchorBL,.anchorBL").hide(),$(".anchorBL a").hide()},again:function(){this.$flg=!0}},mapAddObj={$map:new BMap.Map("address_map"),$text:$("input[name=map_address]"),$dataPass:$(".dataPass"),$val:$(".search_val"),$botton:$(".search_botton"),$lon:null,$lat:null,$marker:null,$point:null,$address:new BMap.Geocoder,init:function(){var e=(new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT}),new BMap.NavigationControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,type:BMAP_NAVIGATION_CONTROL_SMALL}),this);this.$map.addEventListener("click",function(t){e.$lon=t.point.lng,e.$lat=t.point.lat,e.remove(),e.add()}),this.$botton.click(function(){new BMap.LocalSearch(e.$map,{renderOptions:{map:e.$map}}).search(e.$val.val().trim())}),this.$dataPass.click(function(){if(""==e.$text.val())return xxwsWindowObj.xxwsAlert("请选择详细位置！"),!1;eventObj.$mapA.val(e.$text.val()),eventObj.$lon.val(e.$lon),eventObj.$lat.val(e.$lat),eventObj.$mapM.modal("hide")})},reload:function(){this.$map.centerAndZoom(new BMap.Point(116.404,39.915),9),this.$map.enableScrollWheelZoom(!0)},add:function(){this.$point=new BMap.Point(this.$lon,this.$lat),this.$marker=new BMap.Marker(this.$point),this.$map.addOverlay(this.$marker);var e=this;this.$address.getLocation(this.$point,function(t){t&&e.$text.val(t.address)})},remove:function(){this.$map.clearOverlays()}},addListenEventHandle=function(){$("#map_choice").click(function(){var e=$("#table").bootstrapTable("getSelections");e.length>0?mapObj.setPointsMarkerWithCenterPointAndZoomLevel(e):xxwsWindowObj.xxwsAlert("请选择您要展示的信息！")}),$(".bottom_btn span").click(function(){mapObj.mapSwitch()}),$(".addImg").click(function(){$(".feedback_img_list").find(".feedback_images").length<=4?$(".upload_file").trigger("click"):xxwsWindowObj.xxwsAlert("最多上传五张图片")}),$(".pay_list_c1").each(function(e){$(this).click(function(){$(".pay_list_c1").removeClass("on"),$(this).addClass("on"),$(this).find("input[type='radio']").prop("checked",!0)})}),$(document).on("show.bs.modal",".modal",function(e){var t=1040+10*$(".modal:visible").length;$(this).css("z-index",t),setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",t-1).addClass("modal-stack")},0)}),$(document).on("hidden.bs.modal",".modal",function(e){$(".modal:visible").length>0&&$("body").addClass("modal-open")})},mapObj={$user:JSON.parse(lsObj.getLocalStorage("userBo")),$mapBtn:$(".bottom_btn span"),$mapO:$("#event_map"),$bdMap:new BMap.Map("event_map"),$zoom:["50","100","200","500","1000","2000","5000","10000","20000","25000","50000","100000","20000","25000","50000","100000","200000","500000","1000000","2000000"],aCurrentPoints:[],init:function(){this.$bdMap.centerAndZoom(new BMap.Point(116.404,39.915),5),this.$bdMap.enableScrollWheelZoom(!0);var e=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT}),t=new BMap.NavigationControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,type:BMAP_NAVIGATION_CONTROL_SMALL});this.$bdMap.addControl(e),this.$bdMap.addControl(t),this.$bdMap.addControl(new BMap.MapTypeControl)},mapSwitch:function(){this.$mapO.is(":hidden")?this.show():this.hide()},hide:function(){this.$mapO.slideUp(),this.$mapBtn.attr("class","map_down")},show:function(){this.$mapO.slideDown(),this.$mapBtn.attr("class","map_up"),eventObj.iconHide()},setPointsMarkerWithCenterPointAndZoomLevel:function(e){this.$bdMap.clearOverlays(),this.aCurrentPoints=[];var t=e.map(function(e,t,a){return new BMap.Point(e.bdLon,e.bdLat)});this.$bdMap.setViewport(t,{zoomFactor:-1}),this.setPointsMarker(e)},setPointsMarker:function(e){for(var t=null,a=null,n=null,i=null,o=0;o<e.length;o++){var s="";e[o].fullTypeName&&(s=e[o].fullTypeName),t='<div><p class="text">事件类型：'+s+"</p><p>事件状态："+e[o].statusValue+"</p><p>上报人："+e[o].inspectorName+"</p></div>",i=new BMap.Point(e[o].bdLon,e[o].bdLat),a=20==e[o].status?e[o].eventIconName?new BMap.Icon("/src/images/common/process/"+e[o].eventIconName,new BMap.Size(29,42)):new BMap.Icon("/src/images/common/process/D01.png",new BMap.Size(29,42)):e[o].eventIconName?new BMap.Icon("/src/images/common/finish/"+e[o].eventIconName,new BMap.Size(29,42)):new BMap.Icon("/src/images/common/finish/D01.png",new BMap.Size(29,42)),n=new BMap.Marker(i,{icon:a}),this.$bdMap.addOverlay(n),this.aCurrentPoints.push({key:e[o].objectId,value:n}),this.addClickHandler(t,n)}},getMaxPointAndMinPoint:function(e){for(var t=0,a=0,n=999,i=999,o=e.length,s=0;s<o;s++)t<e[s].bdLon&&(t=e[s].bdLon),n>e[s].bdLon&&(n=e[s].bdLon),a<e[s].bdLat&&(a=e[s].bdLat),i>e[s].bdLat&&(i=e[s].bdLat);return{maxLon:t,maxLat:a,minLon:n,minLat:i}},getCenterPointAndZoomLevel:function(e,t,a,n){for(var i=new BMap.Point(e,t),o=new BMap.Point(a,n),s=this.$bdMap.getDistance(i,o).toFixed(1),r={zoomlevel:0,centerPoint:null},l=0,c=this.$zoom.length;l<c;l++)if(this.$zoom[l]-s>0){r.zoomlevel=18-l+3;break}var d=new BMap.Point((e+a)/2,(t+n)/2);return r.centerPoint=d,r},singlePointLocation:function(e){var t=0;this.$bdMap.centerAndZoom(new BMap.Point(e.bdLon,e.bdLat),18);for(var a=0;a<this.aCurrentPoints.length;a++)this.aCurrentPoints[a].key==e.objectId?(t++,this.aCurrentPoints[a].value.setAnimation(BMAP_ANIMATION_BOUNCE)):this.aCurrentPoints[a].value.setAnimation();if(!(t>0)){var n=new BMap.Point(e.bdLon,e.bdLat),i=new BMap.Marker(n),o=null,s=null,r="";e.fullTypeName&&(r=e.fullTypeName),o='<div><p class="text">事件类型：'+r+"</p><p>事件状态："+e.statusValue+"</p><p>上报人："+e.inspectorName+"</p></div>",s=20==e.status?e.eventIconName?new BMap.Icon("/src/images/common/process/"+e.eventIconName,new BMap.Size(29,42)):new BMap.Icon("/src/images/common/process/D01.png",new BMap.Size(29,42)):e.eventIconName?new BMap.Icon("/src/images/common/finish/"+e.eventIconName,new BMap.Size(29,42)):new BMap.Icon("/src/images/common/finish/D01.png",new BMap.Size(29,42)),i=new BMap.Marker(n,{icon:s}),this.$bdMap.addOverlay(i),i.setAnimation(BMAP_ANIMATION_BOUNCE),this.aCurrentPoints.push({key:e.objectId,value:i}),this.addClickHandler(o,i)}},addClickHandler:function(e,t){var a=this;t.addEventListener("click",function(t){a.openInfo(e,t)})},openInfo:function(e,t){var a={width:250,height:80,enableMessage:!0},n=t.target,i=new BMap.Point(n.getPosition().lng,n.getPosition().lat),o=new BMap.InfoWindow(e,a);mapObj.$bdMap.openInfoWindow(o,i)}};window.operateEvents={"click .location":function(e,t,a,n){return"active"==$(this).find("i").attr("class")||($(".location").find("i").attr("class",""),$(this).find("i").attr("class","active"),mapObj.singlePointLocation(a)),$("body,html").animate({scrollTop:0},500),!1},"click .check":function(e,t,a,n){var i=a.objectId;return eventObj._eventObjectId=i,$("#details").modal(),!1}};var exportFileObj={$exportAll:$("#export_all"),$exportChoice:$("#export_choice"),expoerObj:{status:"",type:"",startDate:"",endDate:"",keyword:"",ids:""},init:function(){var e=this;this.$exportAll.click(function(){e.expoerObj.ids="",e.expoerCondition(),1==zhugeSwitch&&zhuge.track("导出事件列表",{action:"导出全部"})}),this.$exportChoice.click(function(){var t=$("#table").bootstrapTable("getSelections"),a=[];if(0==t.length)return xxwsWindowObj.xxwsAlert("请选择你需要导出的任务！"),!1;for(var n=0;n<t.length;n++)a.push(t[n].objectId);e.expoerObj.ids=a.join(","),e.expoerCondition(),1==zhugeSwitch&&zhuge.track("导出事件列表",{action:"导出已选"})})},expoerCondition:function(){searchObj.queryObj;this.expoerObj.status=searchObj.queryObj.status,this.expoerObj.type=searchObj.queryObj.type,this.expoerObj.startDate=searchObj.queryObj.startDate,this.expoerObj.endDate=searchObj.queryObj.endDate,this.expoerObj.keyword=searchObj.queryObj.keyword,this.expoerData(this.expoerObj)},expoerData:function(e){var t={url:"/cloudlink-inspection-event/eventInfo/exportExcel?token="+lsObj.getLocalStorage("token"),data:e,method:"post"};this.downLoadFile(t)},downLoadFile:function(e){var t=$.extend(!0,{method:"post"},e),a=$('<iframe id="down-file-iframe" />'),n=$('<form target="down-file-iframe" method="'+t.method+'" />');n.attr("action",t.url);for(var i in t.data)n.append('<input type="hidden" name="'+i+'" value="'+t.data[i]+'" />');a.append(n),$(document.body).append(a),n[0].submit(),a.remove()}};