function closeImg(e){var t=$(e).attr("data-key");$(e).closest(".feedback_images").remove(),$(".feedback_img_file input[name=file]").each(function(){console.log($(this).attr("data-value")),$(this).attr("data-value")==t&&$(this).remove()})}function checkLen(e){var t=$(e).val().length;t>159&&$(e).val($(e).val().substring(0,160));var a=160-t;a<0&&(a=0),$(".text_num").text("("+a+"字)")}$(function(){taskObj.init(),$(document).on("show.bs.modal",".modal",function(e){var t=1040+10*$(".modal:visible").length;$(this).css("z-index",t),setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",t-1).addClass("modal-stack")},0)}),$(document).on("hidden.bs.modal",".modal",function(e){$(".modal:visible").length>0&&$("body").addClass("modal-open")}),$(".addImg").click(function(){$(".feedback_img_list").find(".feedback_images").length<=4?$(".upload_file").trigger("click"):xxwsWindowObj.xxwsAlert("最多上传五张图片")})});var taskObj={$submit:$(".submit"),$taskM:$("#dispose"),_datatime:$("#datetime"),$receiveUser:$("input[name=receiveUser]"),receiveUserIdsArr:[],$objectId:null,$taskId:null,$flg:!0,_taskType:null,init:function(){var e=this;this.$submit.click(function(){e.submit()}),this.$receiveUser.click(function(){$("#stakeholder").modal(),e.requestPeopleTree()}),$("#btn_selectPeople").click(function(){e.setSelectedPerson()})},taskOpen:function(e){this.$taskM.modal();var t=(new Date).Format("yyyy-MM-dd HH:mm");this._datatime.text(t),this.$taskId=e},submit:function(){var e=this;this.$objectId=baseOperation.createuuid();var t=$("#event_description").val().trim();this._taskType=$("input[name='taskType']:checked").val();var a=$("input[name='receiveUser']").val();if(1==this.$flg){if(this.$flg=!1,""==t)return xxwsWindowObj.xxwsAlert("请描述处置的信息！"),this.again(),!1;if("20"==this._taskType&&""==a)return xxwsWindowObj.xxwsAlert("请选择【请示】消息的接收人！"),this.again(),!1;var i={tip:"您是否确定提交处置信息？",name_title:"提示",name_cancel:"取消",name_confirm:"确定",isCancelBtnShow:!0,callBack:function(){e.closedWhether(e.$taskId)}};xxwsWindowObj.xxwsAlert(i),e.again()}},uploadFile:function(){var e=0,t=this,a=$(".feedback_img_file").find("input[name=file]");if(a.length>0)for(i=0;i<a.length;i++){var s=a.eq(i).attr("id");$.ajaxFileUpload({url:"/cloudlink-core-file/attachment/web/v1/save?businessId="+t.$objectId+"&bizType=pic&token="+lsObj.getLocalStorage("token"),secureuri:!1,fileElementId:s,dataType:"json",type:"POST",async:!1,success:function(i,s){1==i.success?++e==a.length&&t.uploadData():(xxwsWindowObj.xxwsAlert("当前网络不稳定"),t.again())}})}else t.uploadData()},uploadData:function(){var e=this,t=this.formData();$.ajax({type:"POST",url:"/cloudlink-inspection-task/dispose/save?token="+lsObj.getLocalStorage("token"),contentType:"application/json",data:JSON.stringify(t),dataType:"json",success:function(t,a){1==t.success?($("#event_description").val(""),$("input[name='receiveUser']").val(""),e.$taskM.modal("hide"),window.location.reload()):(xxwsWindowObj.xxwsAlert("当前网络不稳定"),e.again())}})},formData:function(){var e=this,t=$("#datetime").text(),a=$("#event_description").val().trim();return{objectId:this.$objectId,type:e._taskType,content:a,createTime:t,taskId:e.$taskId,receiveUserIds:e.receiveUserIdsArr}},requestPeopleTree:function(){var e=this;e.aAllPeople||$.ajax({type:"GET",url:"/cloudlink-core-framework/user/getOrgUserTree",contentType:"application/json",data:{token:lsObj.getLocalStorage("token"),status:1},dataType:"json",success:function(t){if(1!=t.success)return void xxwsWindowObj.xxwsAlert("网络连接出错！");e.aAllPeople=t.rows,e.renderPeopleTree(e.aAllPeople)},statusCode:{404:function(){xxwsWindowObj.xxwsAlert("网络连接出错！")}}})},renderPeopleTree:function(e){var t=this,a={view:{showLine:!0},data:{key:{name:"treenodename"},simpleData:{enable:!0,pIdKey:"pid"}},check:{enable:!0,chkStyle:"checkbox"}};t.zTree=$.fn.zTree.init($("#people_list"),a,e),t.zTree.expandAll(!0)},setSelectedPerson:function(){var e=this;e.aPeopleName=[],e.receiveUserIdsArr=[];var t=null;e.zTree.getCheckedNodes(!0).forEach(function(a,i){a.isParent||(t={userId:a.id,userName:a.treenodename},e.receiveUserIdsArr.push(t),e.aPeopleName.push(a.treenodename))}),e.$receiveUser.val(e.aPeopleName.join("，")),$("#stakeholder").modal("hide"),console.log(JSON.stringify(this.formData()))},initPeopleList:function(){var e=this;e.aPeopleName=[],e.receiveUserIdsArr=[],e.$receiveUser.val(""),e.zTree&&e.zTree.checkAllNodes(!1)},closedWhether:function(e){var t=this;$.ajax({type:"GET",url:"/cloudlink-inspection-task/task/getTaskStatus?token="+lsObj.getLocalStorage("token")+"&taskId="+e,contentType:"application/json",dataType:"json",success:function(e,a){if(console.log(e),1==e.success){return 21==e.rows[0].status?(xxwsWindowObj.xxwsAlert("您好，该任务已经关闭！"),window.location.reload(),!1):(t.uploadFile(),!0)}}})},again:function(){this.$flg=!0}};